{"version":3,"file":"vote-service.bundle.js","sources":["../src/vote-service.js"],"sourcesContent":["import { VoteApplication } from 'vote.application';\nimport { type BackendVote } from './type';\n\nexport const BackendModuleId = 'im';\nexport const BackendEntityType = 'Bitrix\\\\Vote\\\\Attachment\\\\ImMessageConnector';\n\nexport type EntityAuthParams = {\n\tmoduleId: string,\n\tentityId: number,\n};\n\nexport class ImVoteService\n{\n\t#entityId: number;\n\t#app: VoteApplication = null;\n\n\tconstructor(entityType: string, entityId: number)\n\t{\n\t\tthis.#entityId = entityId;\n\t\tthis.#app = VoteApplication.init();\n\t}\n\n\tload(): Promise<boolean>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#getAttachedVote()\n\t\t\t\t.then((response) => {\n\t\t\t\t\tthis.#updateStore(response?.data?.attach);\n\t\t\t\t\tresolve(true);\n\t\t\t\t})\n\t\t\t\t.catch((response) => reject(response))\n\t\t\t;\n\t\t});\n\t}\n\n\tsendVote(ballot: Record<number, number[]>): Promise\n\t{\n\t\treturn this.#sendBackendVote(ballot).then((response) => {\n\t\t\tthis.#updateStore(response?.data?.attach);\n\n\t\t\treturn response?.data?.attach;\n\t\t});\n\t}\n\n\t#getAttachedVote(): Promise\n\t{\n\t\treturn BX.ajax.runAction('vote.AttachedVote.get', {\n\t\t\tdata: this.#getEntityParams(),\n\t\t});\n\t}\n\n\trevokeVote(): Promise<boolean>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#sendVoteRevokeRequest()\n\t\t\t\t.then((response) => {\n\t\t\t\t\tthis.#updateStore(response?.data?.attach);\n\t\t\t\t\tresolve(true);\n\t\t\t\t})\n\t\t\t\t.catch((response) => {\n\t\t\t\t\tconsole.error(response.errors[0].code);\n\t\t\t\t\treject(response);\n\t\t\t\t});\n\t\t});\n\t}\n\n\tcompleteVote(): Promise<boolean>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#sendVoteStopRequest()\n\t\t\t\t.then(() => {\n\t\t\t\t\tresolve(true);\n\t\t\t\t})\n\t\t\t\t.catch((response) => {\n\t\t\t\t\tconsole.error(response.errors[0].code);\n\t\t\t\t\treject(response);\n\t\t\t\t});\n\t\t});\n\t}\n\n\t#sendVoteStopRequest(): Promise<void>\n\t{\n\t\treturn BX.ajax.runAction('vote.AttachedVote.stop', {\n\t\t\tdata: this.#getEntityParams(),\n\t\t});\n\t}\n\n\t#sendVoteRevokeRequest(): Promise\n\t{\n\t\treturn BX.ajax.runAction('vote.AttachedVote.recall', {\n\t\t\tdata: this.#getEntityParams(),\n\t\t});\n\t}\n\n\t#sendBackendVote(ballot: Record<number, number[]>): Promise\n\t{\n\t\treturn BX.ajax.runAction('vote.AttachedVote.vote', {\n\t\t\tdata: {\n\t\t\t\t...this.#getEntityParams(),\n\t\t\t\tballot,\n\t\t\t},\n\t\t});\n\t}\n\n\t#getEntityParams(): EntityAuthParams\n\t{\n\t\treturn {\n\t\t\tmoduleId: BackendModuleId,\n\t\t\tentityType: BackendEntityType,\n\t\t\tentityId: this.#entityId,\n\t\t};\n\t}\n\n\t#updateStore(payload: ?BackendVote): void\n\t{\n\t\tif (!payload)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#app.getStore().dispatch('vote/setCurrentUserVotes', payload.userAnswerMap);\n\t\tthis.#app.getStore().dispatch('vote/addVote', payload);\n\t\tthis.#app.getStore().dispatch('vote/addQuestion', payload.QUESTIONS);\n\t\tthis.#app.getStore().dispatch('vote/addAnswer', payload.QUESTIONS);\n\t}\n}\n"],"names":["BackendModuleId","BackendEntityType","ImVoteService","constructor","entityType","entityId","VoteApplication","init","load","Promise","resolve","reject","then","response","data","attach","catch","sendVote","ballot","revokeVote","console","error","errors","code","completeVote","BX","ajax","runAction","moduleId","payload","getStore","dispatch","userAnswerMap","QUESTIONS"],"mappings":"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"}