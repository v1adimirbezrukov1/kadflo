{"version":3,"file":"attached-result.bundle.js","sources":["../src/backend.js","../src/answer-voted.js","../src/result-display.js","../src/index.js"],"sourcesContent":["import { BackendVotedUser } from './types';\n\nexport class VoteResultBackend\n{\n\t#signedAttachId: number;\n\t#limit: number;\n\n\tconstructor(signedAttachId: string, limit: number = 10)\n\t{\n\t\tthis.#signedAttachId = signedAttachId;\n\t\tthis.#limit = limit;\n\t}\n\n\tasync loadAnswer(answerId: number, page: number = 1): Promise<BackendVotedUser[]>\n\t{\n\t\tconst data = {\n\t\t\tsignedAttachId: this.#signedAttachId,\n\t\t\tanswerId,\n\t\t};\n\n\t\tconst navigation = {\n\t\t\tsize: this.#limit,\n\t\t\tpage,\n\t\t};\n\n\t\tconst response = await BX.ajax.runAction('vote.AttachedVote.getAnswerVoted', { data, navigation });\n\n\t\treturn response?.data?.items ?? [];\n\t}\n}\n","import { Loc } from 'main.core';\nimport type { PopupOptions } from 'main.popup';\nimport { VoteResultBackend } from './backend';\nimport type { BackendVotedUser } from './types';\nimport { Popup } from 'ui.vue3.components.popup';\nimport { BIcon } from 'ui.icon-set.api.vue';\nimport 'ui.icon-set.main';\nimport 'ui.icon-set.animated';\n\nexport const VoteAnswerVoted = {\n\tname: 'VoteAnswerVoted',\n\tcomponents: { Popup, BIcon },\n\tprops: {\n\t\tcount: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tfirstPageVoted: {\n\t\t\t/** @type BackendVotedUser[] */\n\t\t\ttype: Array,\n\t\t\trequired: true,\n\t\t},\n\t\tsignedAttachId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tanswerId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tmaxVisibleAvatarsCount:\t{\n\t\t\ttype: Number,\n\t\t\trequired: false,\n\t\t\tdefault: 3,\n\t\t},\n\t\tpageSize: {\n\t\t\ttype: Number,\n\t\t\trequired: true,\n\t\t},\n\t},\n\tdata(): { voted: BackendVotedUser[], page: number }\n\t{\n\t\treturn {\n\t\t\tvoted: this.firstPageVoted,\n\t\t\tpage: 1,\n\t\t\tloading: false,\n\t\t\texpanded: false,\n\t\t};\n\t},\n\tcomputed: {\n\t\tcountNumber(): number\n\t\t{\n\t\t\treturn parseInt(this.count, 10);\n\t\t},\n\t\tvotedCountTitle(): string\n\t\t{\n\t\t\treturn Loc.getMessagePlural('VOTE_JS_ATTACHED_RESULT_ANSWER_VOTED_COUNT', this.countNumber, {\n\t\t\t\t'#COUNT#': this.countNumber,\n\t\t\t});\n\t\t},\n\t\tfirstPageVotedWithAvatars(): BackendVotedUser[]\n\t\t{\n\t\t\treturn this.firstPageVoted.filter((votedUser: BackendVotedUser) => Boolean(votedUser.IMAGE))\n\t\t\t\t.slice(0, this.maxVisibleAvatarsCount)\n\t\t\t;\n\t\t},\n\t\tpopupOptions(): PopupOptions\n\t\t{\n\t\t\treturn {\n\t\t\t\tbindElement: this.$refs.votedLink,\n\t\t\t\tborderRadius: '18px',\n\t\t\t\tautoHide: true,\n\t\t\t};\n\t\t},\n\t},\n\tmethods: {\n\t\tasync popupScrollHandler(event): Promise<void>\n\t\t{\n\t\t\tif (this.loading)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.countNumber <= this.voted.length)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (event.target.scrollHeight - event.target.scrollTop > event.target.clientHeight)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.loading = true;\n\t\t\tconst nextPage = this.page + 1;\n\t\t\tconst backend = new VoteResultBackend(this.signedAttachId, this.pageSize);\n\t\t\ttry\n\t\t\t{\n\t\t\t\tconst nextPageUsers: BackendVotedUser[] = await backend.loadAnswer(this.answerId, nextPage);\n\t\t\t\tthis.page = nextPage;\n\t\t\t\tthis.voted = [...this.voted, ...nextPageUsers];\n\t\t\t}\n\t\t\tcatch (error)\n\t\t\t{\n\t\t\t\tconsole.error(error);\n\t\t\t}\n\t\t\tfinally\n\t\t\t{\n\t\t\t\tthis.loading = false;\n\t\t\t}\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"vote-answer-voted\">\n\t\t\t<div v-if=\"firstPageVotedWithAvatars.length > 0\" class=\"vote-answer-avatars\">\n\t\t\t\t<img class=\"vote-answer-avatar\" v-for=\"(user, index) in firstPageVotedWithAvatars\" :key=\"index\" :src=\"user.IMAGE\" :alt=\"user.NAME\" />\n\t\t\t</div>\n\t\t\t<div class=\"vote-answer-voted-link\" @click=\"expanded = true\" ref=\"votedLink\">\n\t\t\t\t<div class=\"vote-answer-voted-title\">{{ votedCountTitle }}</div>\n\t\t\t\t<div class=\"vote-answer-voted-down\"></div>\n\t\t\t</div>\n\t\t\t<Popup v-if=\"expanded\" :options=\"popupOptions\" @close=\"expanded = false\">\n\t\t\t\t<div class=\"vote-answer-popup-container\" @scroll=\"this.popupScrollHandler($event)\">\n\t\t\t\t\t<div v-for=\"(user, index) in voted\" :key=\"index\" class=\"vote-answer-voted-user\">\n\t\t\t\t\t\t<img v-if=\"user.IMAGE\" class=\"vote-answer-popup-avatar\" :src=\"user.IMAGE\" />\n\t\t\t\t\t\t<BIcon v-if=\"!user.IMAGE\"\n\t\t\t\t\t\t\t   class=\"vote-answer-popup-avatar\"\n\t\t\t\t\t\t\t   :name=\"'person'\"\n\t\t\t\t\t\t\t   :size=\"26\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div class=\"vote-answer-voted-user-name\">{{ user.NAME }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<BIcon v-if=\"loading\" :name=\"'loader-wait'\" :size=\"20\" />\n\t\t\t\t</div>\n\t\t\t</Popup>\n\t\t</div>\n\t`,\n};\n","import { Loc } from 'main.core';\nimport { VoteAnswerVoted } from './answer-voted';\nimport type { BackendVotedUser } from './types';\nexport const VoteResultDisplay = {\n\tname: 'VoteResultDisplay',\n\tcomponents: { VoteAnswerVoted },\n\tprops: {\n\t\tloadedData: {\n\t\t\t/** @type {BackendResultAll} */\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tvotedPageSize: {\n\t\t\ttype: Number,\n\t\t\trequired: true,\n\t\t},\n\t},\n\tcomputed:\n\t{\n\t\tanonymityLabel(): string\n\t\t{\n\t\t\treturn this.loadedData?.attach?.ANONYMITY > 1\n\t\t\t\t? this.$Bitrix.Loc.getMessage('VOTE_JS_ATTACHED_RESULT_ANONYMOUS')\n\t\t\t\t: this.$Bitrix.Loc.getMessage('VOTE_JS_ATTACHED_RESULT_PUBLIC')\n\t\t\t\t;\n\t\t},\n\t},\n\tmethods: {\n\t\tgetVoted(answerId: number): BackendVotedUser[]\n\t\t{\n\t\t\treturn this.loadedData.voted?.[answerId] ?? [];\n\t\t},\n\t\tisAnswerSelected(questionId: number, answerId: number): boolean\n\t\t{\n\t\t\treturn this.loadedData.attach.userAnswerMap?.[questionId]?.[answerId] ?? false;\n\t\t},\n\t\tgetQuestionVoted(count: number): string\n\t\t{\n\t\t\treturn Loc.getMessagePlural('VOTE_JS_ATTACHED_RESULT_QUESTION_VOTED_COUNT', parseInt(count, 10), {\n\t\t\t\t'#COUNT#': count,\n\t\t\t});\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"vote-result-wrapper\">\n\t\t\t<div v-if=\"loadedData\">\n\t\t\t\t<div class=\"ui-text-4\">{{ anonymityLabel }}</div>\n\t\t\t\t<div v-for=\"(question, questionId) in loadedData?.attach?.QUESTIONS\" :key=\"questionId\">\n\t\t\t\t\t<div class=\"ui-title-3\">{{ question.QUESTION }}</div>\n\t\t\t\t\t<div class=\"ui-text-4\">{{ this.getQuestionVoted(question.COUNTER) }}</div>\n\t\t\t\t\t<div class=\"vote-result-answer\" v-for=\"(answer, answerId) in question.ANSWERS\" :key=\"answerId\">\n\t\t\t\t\t\t<div class=\"vote-result-answer-inner\" :class=\"{ 'vote-answer-user': this.isAnswerSelected(questionId, answerId) }\">\n\t\t\t\t\t\t\t<div class=\"vote-answer-message\">{{ answer.MESSAGE }}</div>\n\t\t\t\t\t\t\t<div class=\"vote-answer-percent\">\n\t\t\t\t\t\t\t\t<span class=\"vote-answer-percent-digit\">{{ Math.round(answer.PERCENT) }}</span>\n\t\t\t\t\t\t\t\t<span class=\"vote-answer-percent-symbol\">%</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass=\"vote-result-answer-inner-percent\"\n\t\t\t\t\t\t\t\t:style=\"{ width: answer.PERCENT + '%' }\"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div v-if=\"this.getVoted(answerId).length > 0\">\n\t\t\t\t\t\t\t<VoteAnswerVoted\n\t\t\t\t\t\t\t\t:count=\"answer.COUNTER\"\n\t\t\t\t\t\t\t\t:firstPageVoted=\"getVoted(answerId)\"\n\t\t\t\t\t\t\t\t:signedAttachId=\"loadedData.attach.signedAttachId\"\n\t\t\t\t\t\t\t\t:answerId=\"answerId\"\n\t\t\t\t\t\t\t\t:pageSize=\"votedPageSize\"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if=\"!loadedData\">\n\t\t\t\t{{ this.$Bitrix.Loc.getMessage('VOTE_JS_ATTACHED_RESULT_LOAD_ERROR') }}\n\t\t\t</div>\n\t\t</div>\n\t`,\n};\n","import { VoteResultDisplay } from './result-display';\nimport type { BackendResultAll, VoteAttachedResultOptions } from './types';\nimport { BitrixVue, VueCreateAppResult } from 'ui.vue3';\nimport './style.css';\n\nexport class VoteAttachedResult\n{\n\t#application: VueCreateAppResult;\n\t#votedPageSize: number;\n\n\tconstructor(options: VoteAttachedResultOptions)\n\t{\n\t\tthis.#votedPageSize = options.votedPageSize || 10;\n\t}\n\n\tcreateApplicationWithResult(backendResult: BackendResultAll): VueCreateAppResult\n\t{\n\t\treturn BitrixVue.createApp({\n\t\t\tname: 'VoteAttachedResultRoot',\n\t\t\tcomponents: { VoteResultDisplay },\n\t\t\tprops: {\n\t\t\t\tloaded: {\n\t\t\t\t\ttype: Object,\n\t\t\t\t\trequired: true,\n\t\t\t\t},\n\t\t\t\tvotedPageSize: {\n\t\t\t\t\ttype: Number,\n\t\t\t\t\trequired: true,\n\t\t\t\t},\n\t\t\t},\n\t\t\ttemplate: '<VoteResultDisplay :loadedData=\"loaded\" :votedPageSize=\"votedPageSize\"/>',\n\t\t}, {\n\t\t\tloaded: backendResult,\n\t\t\tvotedPageSize: this.#votedPageSize,\n\t\t});\n\t}\n\n\trenderTo(backendResult: BackendResultAll, container: HTMLElement): void\n\t{\n\t\tthis.#application = this.createApplicationWithResult(backendResult);\n\t\tthis.#application.mount(container);\n\t}\n}\n"],"names":["VoteResultBackend","constructor","signedAttachId","limit","loadAnswer","answerId","page","data","navigation","size","response","BX","ajax","runAction","items","VoteAnswerVoted","name","components","Popup","BIcon","props","count","type","String","required","firstPageVoted","Array","maxVisibleAvatarsCount","Number","default","pageSize","voted","loading","expanded","computed","countNumber","parseInt","votedCountTitle","Loc","getMessagePlural","firstPageVotedWithAvatars","filter","votedUser","Boolean","IMAGE","slice","popupOptions","bindElement","$refs","votedLink","borderRadius","autoHide","methods","popupScrollHandler","event","length","target","scrollHeight","scrollTop","clientHeight","nextPage","backend","nextPageUsers","error","console","template","VoteResultDisplay","loadedData","Object","votedPageSize","anonymityLabel","attach","ANONYMITY","$Bitrix","getMessage","getVoted","isAnswerSelected","questionId","userAnswerMap","getQuestionVoted","VoteAttachedResult","options","createApplicationWithResult","backendResult","BitrixVue","createApp","loaded","renderTo","container","mount"],"mappings":"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"}