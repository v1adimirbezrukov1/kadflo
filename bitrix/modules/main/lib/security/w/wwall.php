<? namespace Bitrix\Main\Security\W;$GLOBALS['____1099143504']= array(base64_decode(''.'dGltZQ='.'='),base64_decode('dGl'.'tZQ=='),base64_decode('anN'.'vb'.'l9kZWNvZGU'.'='),base64_decode(''.'YXJyYXlfbWVyZ2U='),base64_decode('a'.'m'.'9pbg=='),base64_decode('a'.'m9pb'.'g=='),base64_decode('am9pbg=='),base64_decode('YXJy'.'YXlfcG9w'),base64_decode('YX'.'JyYXlfc2hpZnQ='),base64_decode('YXJ'.'y'.'Y'.'Xl'.'fc2hpZnQ='),base64_decode(''.'YX'.'JyYX'.'lfc2hpZnQ'.'='),base64_decode('Y'.'X'.'Jy'.'YXl'.'fc2hp'.'ZnQ='),base64_decode('YXJyYXlfbWVyZ2U'.'='),base64_decode('aXNfYXJ'.'yYX'.'k='),base64_decode('Y'.'XJyYXlfb'.'WV'.'yZ2U='),base64_decode('aW5fYXJ'.'yYX'.'k='),base64_decode('aW5'.'fYXJyYXk='),base64_decode('aW5'.'f'.'YXJ'.'yY'.'Xk='),base64_decode('aW5fYXJ'.'yYXk='),base64_decode('aW5fYXJyYXk'.'='),base64_decode(''.'dG'.'lt'.'ZQ=='),base64_decode(''.'dG'.'lt'.'ZQ=='),base64_decode('YXJyYXlfbWFw'),base64_decode('Z2V0X2xvY'.'WRlZF9'.'leH'.'Rlb'.'nNpb'.'25z'),base64_decode('anN'.'vbl9'.'lbmNvZG'.'U'.'='),base64_decode('an'.'Nv'.'bl'.'9'.'lbmNvZGU='),base64_decode('cGhwdmVyc2lvb'.'g'.'=='),base64_decode('a'.'nNvbl'.'9lbmNv'.'ZGU='),base64_decode('am9pb'.'g='.'='));if(!function_exists(__NAMESPACE__.'\\___1203717916')){function ___1203717916($_767900943){static $_1794339377= false; if($_1794339377 == false) $_1794339377=array('V1dBT'.'ExfTE9DSw==','c2VjdXJpdHk=','RE'.'FUQ'.'Q==','eyI=','V'.'1dBTExfTE9DSw='.'=','c2VjdXJpdHk=','U0VDVV'.'JJ'.'VFlfV1'.'dB'.'TExfRVhDRVB'.'US'.'U'.'9O','Rk'.'FJTF9'.'DSE'.'VDS'.'0lOR'.'w='.'=','Q'.'2FuIG5vdC'.'BleGVjdX'.'RlIHd'.'3Y'.'Wx'.'sIHJ1b'.'GVzOiA=','IFRy'.'Y'.'WNlOiA=','UkVRVU'.'VTVF'.'9VUkk=',''.'a2V5cw'.'==','dmFsdWV'.'z','U0VD'.'VVJJ'.'VF'.'lfV1dBTExfT'.'U9ESUZZ','L'.'g==','U'.'0VDV'.'VJ'.'JVF'.'l'.'fV1dBTExfV'.'U5'.'TRVQ=',''.'Lg==','U0VDVV'.'JJVFlf'.'V1d'.'BTExfRVh'.'JVA==','L'.'g==','Z'.'2x'.'vYmFs','a2V5cw==','dmF'.'sdWVz','Z'.'2'.'V'.'0','Z'.'2V'.'0',''.'cG'.'9'.'zdA==','cG9zd'.'A'.'==','Y29va2ll','Y'.'29va2ll','cmVx'.'dWV'.'zdA==','c'.'mVxdWVz'.'dA==',''.'Z2xvYmFs',''.'Z2x'.'v'.'YmF'.'s',''.'bWF'.'pbl9'.'zZWM'.'=','V1dBTExfQUNUVU'.'FMS'.'VpFX1JV'.'T'.'EVT','dg='.'=','d'.'m'.'Vyc'.'2l'.'vbg='.'=','a'.'Q==','aXN'.'JbnN'.'0YWxsZWQ=','dg==','aW5'.'p','bW9kdWx'.'lc'.'w'.'='.'=','bGljZ'.'W5zZQ='.'=','cGhw',''.'dg==','ZXh'.'0','c2'.'VjdXJpdHk=',''.'ZGI=','dH'.'lwZQ'.'==','ZGI=','d'.'mV'.'yc'.'2lvbg==',''.'ZGI=','dHlwZ'.'Q='.'=',''.'ZG'.'I=','d'.'Hl'.'wZQ==','dmVy'.'c2lvbg='.'=','ZGI=','dmVyc2lvb'.'g==','ZW52aXJvbm1lbnQ=',''.'dm'.'1fdm'.'V'.'yc2lvbg='.'=','dm0=',''.'dg==','ZW'.'52aXJvbm1lb'.'n'.'Q=','dm1fdmVyc2lvb'.'g'.'==','c'.'29ja2V0VG'.'l'.'tZ'.'W91'.'dA==','c3R'.'yZWF'.'tVG'.'lt'.'ZW9'.'1d'.'A==','KCc=','ZG'.'F0YQ==','Jywg'.'Jw==',''.'bW9'.'kdWxl','Jy'.'wgJw='.'=','bW9kdWxl'.'X3ZlcnNpb24'.'=',''.'Jyk=','LCA=','U0V'.'DV'.'V'.'JJ'.'VFl'.'fV1d'.'BTExfRVhDRV'.'BUSU'.'9'.'O','bWF'.'pbg==','RkFJTF9SR'.'UZSR'.'VNISU5H','Q2'.'FuIG5'.'vdCByZWZyZXN'.'oIHd3YWxsIH'.'J'.'1b'.'GVzOiA=','IFRyYW'.'Nl'.'Oi'.'A=','ZGF0YQ'.'==','eyI=','LS0'.'tLS1CR'.'UdJTi'.'BQVU'.'JMS'.'U'.'MgS0VZL'.'S0tL'.'S'.'0=','Ck1JSUJJa'.'kFOQ'.'mdr'.'cWhraUc5dzBCQVFFRkF'.'BT'.'0'.'NBU'.'ThBT'.'UlJQkNnS0NBUUVBcThRRTBI'.'am1ISlVTdFdWN'.'m'.'4wemEKUlZvT'.'Hgw'.'Mkt6YmZyY'.'lMvUD'.'Z'.'zV2'.'F'.'4VHp3OF'.'NlR1R'.'0'.'YlRDT3Jw'.'S'.'Gk1UUY2T1J5'.'alovW'.'Hh6L0tMVTFH'.'Ym'.'9mO'.'UNaMwo0ejdTa3FVdD'.'Y2a'.'W'.'JYd'.'k'.'9GQ'.'ng0ZncvQV'.'BQ'.'UkdEcX'.'Rt'.'M'.'G5EM'.'2Zn'.'R3N1M'.'1'.'J'.'lU'.'Gd'.'3'.'MjlpOCt2bTd'.'tdEJLSlVZ'.'bDRyClZwYjZzZl'.'pFVDlL'.'RW'.'I2VDFIRFl'.'tRXZjMWhxL2l'.'pdXl4THJaWmk1UTZV'.'ZmY0VUV2VEkrN'.'jhzc0ZSa1'.'Erb'.'3d'.'UUnk'.'KZ'.'U9'.'JTWJGa'.'E'.'0'.'vV'.'VRtZlZZ'.'YlRSRnk'.'y'.'b'.'1VROFdNemEy'.'bko1'.'U2Foe'.'mkxV'.'UtPMWp'.'Bal'.'hUUF'.'J'.'ye'.'mM3QW'.'p1N'.'jM5aj'.'FPMA'.'pw'.'cHF'.'mbT'.'V'.'4Z'.'1dsRk'.'FKa0hRVGdiZ'.'G'.'Q1'.'QVd'.'xR'.'EZRa3Q5SEtr'.'WStUbmZCTEd'.'W'.'TXZ'.'W'.'eVB3VEhOV1FZQXc0eHBnL3dB'.'Cl'.'p3SUR'.'BUUFCCi0tLS0'.'t'.'RU5EIFBVQkx'.'JQ'.'yBLRVktLS0tLQ==');return base64_decode($_1794339377[$_767900943]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_727740716= 'https://wwall.bitrix.info/rules.php'; protected $_1336472659= true; public function handle(){ try{  $_1234684326= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1234684326)){ return;}  $_1814721165= Cache::createInstance(); $_270603035= false; if($_1814721165->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1084009047= $_1814721165->getVars(); if($GLOBALS['____1099143504'][0]()- $_1084009047> round(0+5+5+5+5)){  $_605649475= Application::getConnection(); $_398751192= RuleRecordTable::getTableName(); $_605649475->truncateTable($_398751192); RuleRecordTable::cleanCache(); $_1814721165->clean(___1203717916(0), ___1203717916(1));}} elseif($_1814721165->startDataCache()){  $_1814721165->endDataCache($GLOBALS['____1099143504'][1]()); $_270603035= true;} foreach($_1234684326 as $_1008924568){ $_767946909= new PublicKeyCipher; $_1068446007= $_767946909->decrypt($_1008924568[___1203717916(2)], static::__406081794()); if(!str_starts_with($_1068446007, ___1203717916(3))){ continue;} $_1178262335= $GLOBALS['____1099143504'][2]($_1068446007, true); if(!empty($_1178262335)){ $_850008400= Rule::make($_1178262335); $_1529715869= $this->handleRule($_850008400); $this->applyHandlingResults($_1529715869);}}  if($_270603035){ $_1814721165->clean(___1203717916(4), ___1203717916(5));}} catch(\Throwable $_80243168){ $this->logEvent( ___1203717916(6), ___1203717916(7), ___1203717916(8). $_80243168->getMessage(). ___1203717916(9). $_80243168->getTraceAsString());}}  public function handleRule(Rule $_850008400): array{ $_1529715869=[]; if($_850008400->matchPath($_SERVER[___1203717916(10)])){  $_1725631496= $this->getContextElements($_850008400->getContext()); foreach($_1725631496 as $_1792721395 => &$_792537951){ $_1529715869= $GLOBALS['____1099143504'][3]($_1529715869, $this->recursiveContextKeyHandle($_1792721395, $_792537951,[], $_850008400));}} return $_1529715869;}  public function applyHandlingResults(array $_1529715869){ $_1725631496= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1529715869 as $_50173896){ $_792537951=& $_1725631496[$_50173896->getContextName()]; $_1718458864= $_50173896->getRuleResult(); $_850008400= $_50173896->getRule(); if($_1718458864 instanceof ModifyResult){ if($_850008400->getProcess() === ___1203717916(11)){  static::rewriteContextKey( $_50173896->getContextName(), $_792537951, $_50173896->getContextKey(), $_1718458864->getCleanValue());} elseif($_850008400->getProcess() === ___1203717916(12)){ static::rewriteContextValue( $_50173896->getContextName(), $_792537951, $_50173896->getContextKey(), $_1718458864->getCleanValue());} $this->logEvent( ___1203717916(13), $_50173896->getContextName(), $GLOBALS['____1099143504'][4](___1203717916(14), $_50173896->getContextKey()));} elseif($_1718458864 instanceof CheckResult &&!$_1718458864->isSuccess()){ if($_1718458864->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_50173896->getContextName(), $_792537951, $_50173896->getContextKey(),); $this->logEvent( ___1203717916(15), $_50173896->getContextName(), $GLOBALS['____1099143504'][5](___1203717916(16), $_50173896->getContextKey()));} elseif($_1718458864->getAction() === RuleAction::EXIT){ $this->logEvent( ___1203717916(17), $_50173896->getContextName(), $GLOBALS['____1099143504'][6](___1203717916(18), $_50173896->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1336472659= false;} protected function rewriteContextKey($_1792721395, &$_792537951, $_2112369407, $_1192016278){ $_1760702337= $_2112369407;  $GLOBALS['____1099143504'][7]($_1760702337); $_1760702337[]= $_1192016278; if($_1792721395 === ___1203717916(19)){ $_132875768= $GLOBALS['____1099143504'][8]($_2112369407); $GLOBALS['____1099143504'][9]($_1760702337); if(empty($_2112369407)){ $GLOBALS[$_1192016278]= $GLOBALS[$_132875768]; unset($GLOBALS[$_132875768]);} else{ $_792537951=& $GLOBALS[$_132875768]; $_270187916= ArrayHelper::getByNestedKey($_792537951, $_2112369407);  ArrayHelper::setByNestedKey($_792537951, $_1760702337, $_270187916);  ArrayHelper::unsetByNestedKey($_792537951, $_2112369407);}} else{ $_270187916= ArrayHelper::getByNestedKey($_792537951, $_2112369407);  ArrayHelper::setByNestedKey($_792537951, $_1760702337, $_270187916);  ArrayHelper::unsetByNestedKey($_792537951, $_2112369407);}} protected function rewriteContextValue($_1792721395, &$_792537951, $_518744579, $_270187916){ if($_1792721395 === 'global'){ $_132875768= $GLOBALS['____1099143504'][10]($_518744579); if(empty($_518744579)){ $GLOBALS[$_132875768]= $_270187916;} else{ $_792537951=& $GLOBALS[$_132875768]; ArrayHelper::setByNestedKey($_792537951, $_518744579, $_270187916);}} else{  ArrayHelper::setByNestedKey($_792537951, $_518744579, $_270187916);}} protected function unsetContextValue($_1792721395, &$_792537951, $_518744579){ if($_1792721395 === 'global'){ $_132875768= $GLOBALS['____1099143504'][11]($_518744579); if(empty($_518744579)){ unset($GLOBALS[$_132875768]);} else{ $_792537951=& $GLOBALS[$_132875768]; ArrayHelper::unsetByNestedKey($_792537951, $_518744579);}} else{ ArrayHelper::unsetByNestedKey($_792537951, $_518744579);}}  protected function recursiveContextKeyHandle(string $_1792721395, array &$_792537951, array $_1591252620, Rule $_850008400): array{  $_1529715869=[]; foreach($_792537951 as $_1397292098 => $_270187916){ $_518744579= $GLOBALS['____1099143504'][12]($_1591252620,[$_1397292098]); if($_850008400->matchKey($_518744579)){  if($_850008400->getProcess() === ___1203717916(20)){ $_1718458864= $_850008400->evaluate($_1397292098);} elseif($_850008400->getProcess() === ___1203717916(21)){ $_1718458864= $_850008400->evaluateValue($_270187916);}  if(!empty($_1718458864) && $_1718458864 instanceof RuleResult){ $_1529715869[]= new HandlingResult($_1792721395, $_518744579, $_1718458864, $_850008400);}}  if($GLOBALS['____1099143504'][13]($_270187916)){ $_1529715869= $GLOBALS['____1099143504'][14]($_1529715869, $this->recursiveContextKeyHandle( $_1792721395, $_792537951[$_1397292098], $_518744579, $_850008400));}} return $_1529715869;} protected function getContextElements(array $_1570271907){ $_1571165588=[]; if($GLOBALS['____1099143504'][15](___1203717916(22), $_1570271907, true)){ $_1571165588[___1203717916(23)]= &$_GET;} if($GLOBALS['____1099143504'][16](___1203717916(24), $_1570271907, true)){ $_1571165588[___1203717916(25)]= &$_POST;} if($GLOBALS['____1099143504'][17](___1203717916(26), $_1570271907, true)){ $_1571165588[___1203717916(27)]= &$_COOKIE;} if($GLOBALS['____1099143504'][18](___1203717916(28), $_1570271907, true)){ $_1571165588[___1203717916(29)]= &$_REQUEST;} if($GLOBALS['____1099143504'][19](___1203717916(30), $_1570271907, true)){ $_1571165588[___1203717916(31)]= $GLOBALS;} return $_1571165588;} public static function refreshRules(){ try{ $_1990408005= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1099143504'][20]()- $_1990408005)< static::CACHE_RULES_TTL){ return;} Option::set(___1203717916(32), ___1203717916(33), $GLOBALS['____1099143504'][21]()); $_2099745942= null;  $_1285647887= $GLOBALS['____1099143504'][22](function($_704956629){ return[___1203717916(34) => $_704956629[___1203717916(35)], ___1203717916(36) => (int) $_704956629[___1203717916(37)]];}, ModuleManager::getModulesFromDisk());  $_1705630087=[]; foreach($GLOBALS['____1099143504'][23]() as $_905430268){ $_2138753980= new ReflectionExtension($_905430268); $_1705630087[$_905430268]=[ ___1203717916(38) => $_2138753980->getVersion(), ___1203717916(39) => $_2138753980->getINIEntries()];} $_2104093145=[ ___1203717916(40) => $GLOBALS['____1099143504'][24]($_1285647887), ___1203717916(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1203717916(42) => $GLOBALS['____1099143504'][25]([ ___1203717916(43) => $GLOBALS['____1099143504'][26](), ___1203717916(44) => $_1705630087])]; if(Loader::includeModule(___1203717916(45))){ $_745488519= CSecuritySystemInformation::getSystemInformation(); if(isset($_745488519[___1203717916(46)][___1203717916(47)]) && isset($_745488519[___1203717916(48)][___1203717916(49)])){ $_2104093145[___1203717916(50)]=[ ___1203717916(51) => $_745488519[___1203717916(52)][___1203717916(53)], ___1203717916(54) => $_745488519[___1203717916(55)][___1203717916(56)]];} if(isset($_745488519[___1203717916(57)][___1203717916(58)])){ $_2104093145[___1203717916(59)]=[___1203717916(60) => $_745488519[___1203717916(61)][___1203717916(62)]];}}  $_143231349= new HttpClient([ ___1203717916(63) => round(0+5), ___1203717916(64) => round(0+1.25+1.25+1.25+1.25)]); $_2098363408= $_143231349->post( static::$_727740716, $_2104093145); if($_143231349->getStatus() == round(0+200) &&!empty($_2098363408)){ $_2099745942= Json::decode($_2098363408);}  if($_2099745942 !== null){ $_605649475= Application::getConnection(); $_398751192= RuleRecordTable::getTableName(); if(!empty($_2099745942)){ foreach($_2099745942 as $_2000566679){ if(!static::checkRuleSign($_2000566679)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1099143504'][27]($_2000566679));}}}  $_605649475->truncateTable($_398751192);  if(!empty($_2099745942)){ $_2097749025=[]; foreach($_2099745942 as $_2000566679){ $_2097749025[]= ___1203717916(65). $_605649475->getSqlHelper()->forSql($_2000566679[___1203717916(66)]). ___1203717916(67). $_605649475->getSqlHelper()->forSql($_2000566679[___1203717916(68)]). ___1203717916(69). $_605649475->getSqlHelper()->forSql($_2000566679[___1203717916(70)]). ___1203717916(71);} $_823160153= $GLOBALS['____1099143504'][28](___1203717916(72), $_2097749025);  $_605649475->query("INSERT INTO {$_398751192} (DATA, MODULE, MODULE_VERSION) VALUES {$_823160153}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_80243168){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1203717916(73), ___1203717916(74), ___1203717916(75), ___1203717916(76). $_80243168->getMessage(). ___1203717916(77). $_80243168->getTraceAsString());}} protected static function checkRuleSign($_850008400){ $_767946909= new PublicKeyCipher; $_1178262335= $_767946909->decrypt($_850008400[___1203717916(78)], static::__406081794()); return str_starts_with($_1178262335, ___1203717916(79));} private static function __406081794(){ $_514736986= ''; $_514736986 .= ___1203717916(80); $_514736986 .= ___1203717916(81); return $_514736986;} protected function logEvent($_1977666454, $_283377808, $_1739095046){ if($this->_1336472659){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1977666454, 'main', $_283377808, $_1739095046);}}}?>